<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlantLog - Your Garden Journal</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Work+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --earth-dark: #2d3a2e;
            --earth-medium: #4a5d4e;
            --sage: #7a9b7f;
            --moss: #99b89d;
            --cream: #f5f3ed;
            --sand: #e8e3d6;
            --terra: #b87a5c;
            --clay: #8b6347;
            --leaf: #5f8a5f;
            --sprout: #a8d5a3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--sand) 100%);
            color: var(--earth-dark);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(122, 155, 127, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(168, 213, 163, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 60px 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(45, 58, 46, 0.15);
            max-width: 450px;
            width: 100%;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3em;
            font-weight: 700;
            color: var(--earth-dark);
            margin-bottom: 5px;
            letter-spacing: -1px;
        }

        .logo p {
            color: var(--sage);
            font-size: 0.95em;
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--earth-medium);
            font-size: 0.9em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--sand);
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Work Sans', sans-serif;
            transition: all 0.3s ease;
            background: var(--cream);
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--sage);
            background: white;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: var(--earth-dark);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 10px;
        }

        .btn:hover {
            background: var(--earth-medium);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(45, 58, 46, 0.2);
        }

        .btn-secondary {
            background: transparent;
            color: var(--earth-dark);
            border: 2px solid var(--earth-dark);
        }

        .btn-secondary:hover {
            background: var(--earth-dark);
            color: white;
        }

        .btn-link {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: var(--earth-medium);
            border: none;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: underline;
            margin-top: 10px;
        }

        .btn-link:hover {
            color: var(--earth-dark);
        }

        /* Main App */
        .hidden {
            display: none !important;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(45, 58, 46, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2em;
            color: var(--earth-dark);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--cream);
            border-radius: 25px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--sage), var(--leaf));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .btn-small {
            padding: 10px 20px;
            background: var(--earth-dark);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-small:hover {
            background: var(--earth-medium);
            transform: translateY(-1px);
        }

        .btn-add {
            background: var(--leaf);
            padding: 12px 24px;
            font-size: 1em;
        }

        .btn-add:hover {
            background: var(--sage);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 28px;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid transparent;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85em;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .tab.active {
            background: var(--earth-dark);
            color: white;
            border-color: var(--earth-dark);
        }

        /* Plant Grid */
        .plants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .plant-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(45, 58, 46, 0.1);
            transition: all 0.4s ease;
            cursor: pointer;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .plant-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 45px rgba(45, 58, 46, 0.15);
        }

        .plant-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--moss), var(--sprout));
        }

        .plant-info {
            padding: 20px;
        }

        .plant-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8em;
            font-weight: 600;
            color: var(--earth-dark);
            margin-bottom: 8px;
        }

        .plant-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: var(--earth-medium);
            margin-bottom: 12px;
        }

        .plant-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-alive {
            background: rgba(168, 213, 163, 0.2);
            color: var(--leaf);
        }

        .status-archived {
            background: rgba(184, 122, 92, 0.2);
            color: var(--clay);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(45, 58, 46, 0.85);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease-out;
        }

        .modal-header {
            padding: 30px;
            border-bottom: 2px solid var(--sand);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2em;
            color: var(--earth-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            color: var(--earth-medium);
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: var(--earth-dark);
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--earth-dark);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--sand);
            border-radius: 8px;
            font-size: 1em;
            font-family: 'Work Sans', sans-serif;
            transition: border-color 0.3s;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--sage);
        }

        .image-upload {
            border: 3px dashed var(--sage);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--cream);
        }

        .image-upload:hover {
            background: white;
            border-color: var(--leaf);
        }

        .image-upload input {
            display: none;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            margin-top: 15px;
        }

        /* Plant Detail View */
        .plant-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .plant-detail-image {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--moss), var(--sprout));
        }

        .plant-detail-info h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5em;
            color: var(--earth-dark);
            margin: 20px 0 10px;
        }

        .plant-detail-section {
            margin-bottom: 20px;
        }

        .plant-detail-section p {
            line-height: 1.6;
            color: var(--earth-medium);
        }

        .updates-timeline {
            margin-top: 30px;
        }

        .update-item {
            background: var(--cream);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid var(--sage);
        }

        .update-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .update-action {
            font-weight: 600;
            color: var(--earth-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9em;
        }

        .update-date {
            color: var(--earth-medium);
            font-size: 0.85em;
        }

        .update-image {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 12px;
        }

        .care-info-box {
            background: linear-gradient(135deg, var(--sage), var(--moss));
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .care-info-box h4 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3em;
            margin-bottom: 12px;
        }

        .care-info-box ul {
            list-style: none;
            line-height: 1.8;
        }

        .care-info-box li::before {
            content: "â€¢ ";
            color: var(--sprout);
            font-weight: bold;
            margin-right: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--earth-medium);
        }

        .empty-state h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2em;
            margin-bottom: 15px;
            color: var(--earth-dark);
        }

        .empty-state p {
            font-size: 1.1em;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .plant-detail {
                grid-template-columns: 1fr;
            }

            .login-box {
                padding: 40px 30px;
            }

            header {
                padding: 20px;
            }

            .plants-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="logo">
                <h1>PlantLog</h1>
                <p>Your Garden Journal</p>
            </div>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="loginUsername" placeholder="Enter your username" autocomplete="username">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password" onkeypress="if(event.key==='Enter') login()">
            </div>
            <button class="btn" onclick="login()">Sign In</button>
            <button class="btn btn-secondary" onclick="showSignup()">Create Account</button>
            <button class="btn-link" onclick="showForgotPassword()">Forgot Password?</button>
            <p style="text-align: center; margin-top: 20px; font-size: 0.85em; color: var(--earth-medium);">
                Password must be at least 8 characters with uppercase, lowercase, and number
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <header>
                <h1>PlantLog</h1>
                <div class="header-actions">
                    <button class="btn-small btn-add" onclick="showAddPlantModal()">+ Add Plant</button>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <span id="usernameDisplay"></span>
                    </div>
                    <button class="btn-small" onclick="logout()">Logout</button>
                </div>
            </header>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('active')">Active Plants</div>
                <div class="tab" onclick="switchTab('archived')">Archived</div>
            </div>

            <div id="activePlantsView">
                <div id="activePlantsList" class="plants-grid"></div>
            </div>

            <div id="archivedPlantsView" class="hidden">
                <div id="archivedPlantsList" class="plants-grid"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Plant Modal -->
    <div id="plantModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="plantModalTitle">Add New Plant</h2>
                <button class="close-btn" onclick="closePlantModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="plantForm" onsubmit="savePlant(event)">
                    <div class="form-group">
                        <label>Plant Name *</label>
                        <input type="text" id="plantName" required placeholder="e.g., Radish Seedling">
                    </div>
                    <div class="form-group">
                        <label>Species/Variety</label>
                        <input type="text" id="plantSpecies" placeholder="e.g., Raphanus sativus">
                    </div>
                    <div class="form-group">
                        <label>Date Planted</label>
                        <input type="date" id="plantDate">
                    </div>
                    <div class="form-group">
                        <label>Parent Plant (optional)</label>
                        <select id="parentPlant">
                            <option value="">None - New Seed/Purchase</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Initial Notes</label>
                        <textarea id="plantNotes" placeholder="Add any notes about this plant..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Plant Photo</label>
                        <div class="image-upload" onclick="document.getElementById('plantImage').click()">
                            <input type="file" id="plantImage" accept="image/*" onchange="previewImage(this, 'plantImagePreview')">
                            <p>ðŸ“· Click to upload a photo</p>
                            <img id="plantImagePreview" class="image-preview hidden">
                        </div>
                    </div>
                    <button type="submit" class="btn">Save Plant</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Plant Detail Modal -->
    <div id="detailModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailPlantName">Plant Details</h2>
                <button class="close-btn" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="detailContent"></div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-small" onclick="showAddUpdateModal()">Add Update</button>
                    <button class="btn-small" onclick="archivePlant()" id="archiveBtn">Archive</button>
                    <button class="btn-small" style="background: var(--terra);" onclick="deletePlant()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Update Modal -->
    <div id="updateModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Plant Update</h2>
                <button class="close-btn" onclick="closeUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="updateForm" onsubmit="saveUpdate(event)">
                    <div class="form-group">
                        <label>Action *</label>
                        <select id="updateAction" required>
                            <option value="">Select an action...</option>
                            <option value="watered">Watered</option>
                            <option value="trimmed">Trimmed</option>
                            <option value="cut">Cut/Harvested</option>
                            <option value="fertilized">Fertilized</option>
                            <option value="repotted">Repotted</option>
                            <option value="transplanted">Transplanted</option>
                            <option value="observation">General Observation</option>
                            <option value="problem">Problem/Issue</option>
                            <option value="dying">Plant Dying</option>
                            <option value="died">Plant Died</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="updateNotes" placeholder="Add details about this update..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Update Photo</label>
                        <div class="image-upload" onclick="document.getElementById('updateImage').click()">
                            <input type="file" id="updateImage" accept="image/*" onchange="previewImage(this, 'updateImagePreview')">
                            <p>ðŸ“· Click to upload a photo</p>
                            <img id="updateImagePreview" class="image-preview hidden">
                        </div>
                    </div>
                    <button type="submit" class="btn">Save Update</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset Password</h2>
                <button class="close-btn" onclick="closeForgotPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="forgotPasswordStep1">
                    <p style="margin-bottom: 20px; color: var(--earth-medium);">
                        Enter your username to verify your identity and reset your password.
                    </p>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="forgotUsername" placeholder="Enter your username">
                    </div>
                    <button class="btn" onclick="verifyUsername()">Continue</button>
                </div>
                <div id="forgotPasswordStep2" class="hidden">
                    <p style="margin-bottom: 20px; color: var(--earth-medium);">
                        Answer your security question to verify your identity.
                    </p>
                    <div class="form-group">
                        <label id="securityQuestionLabel">Security Question</label>
                        <input type="text" id="securityAnswer" placeholder="Your answer">
                    </div>
                    <button class="btn" onclick="verifySecurityAnswer()">Verify</button>
                    <button class="btn btn-secondary" onclick="backToStep1()">Back</button>
                </div>
                <div id="forgotPasswordStep3" class="hidden">
                    <p style="margin-bottom: 20px; color: var(--leaf); font-weight: 500;">
                        âœ“ Identity verified! Create a new password.
                    </p>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
                    </div>
                    <p style="font-size: 0.85em; color: var(--earth-medium); margin-bottom: 20px;">
                        Password must be at least 8 characters with uppercase, lowercase, and number
                    </p>
                    <button class="btn" onclick="resetPassword()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let currentUser = null;
        let plants = [];
        let currentPlantId = null;
        let editingPlantId = null;
        let sessionToken = null;

        // Security Utilities
        async function hashPassword(password, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function generateSalt() {
            const array = new Uint8Array(16);
            crypto.getRandomValues(array);
            return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
        }

        function generateToken() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
        }

        function validatePassword(password) {
            if (password.length < 8) {
                return 'Password must be at least 8 characters long';
            }
            if (!/[A-Z]/.test(password)) {
                return 'Password must contain at least one uppercase letter';
            }
            if (!/[a-z]/.test(password)) {
                return 'Password must contain at least one lowercase letter';
            }
            if (!/[0-9]/.test(password)) {
                return 'Password must contain at least one number';
            }
            return null;
        }

        function validateUsername(username) {
            if (username.length < 3) {
                return 'Username must be at least 3 characters long';
            }
            if (username.length > 20) {
                return 'Username must be no more than 20 characters';
            }
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                return 'Username can only contain letters, numbers, and underscores';
            }
            return null;
        }

        // Session Management
        function createSession(username) {
            sessionToken = generateToken();
            const sessionData = {
                username: username,
                token: sessionToken,
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days
            };
            localStorage.setItem('session', JSON.stringify(sessionData));
            return sessionToken;
        }

        function validateSession() {
            const sessionData = localStorage.getItem('session');
            if (!sessionData) return false;

            try {
                const session = JSON.parse(sessionData);
                const now = new Date();
                const expiresAt = new Date(session.expiresAt);

                if (now > expiresAt) {
                    localStorage.removeItem('session');
                    return false;
                }

                sessionToken = session.token;
                currentUser = { username: session.username };
                return true;
            } catch (e) {
                localStorage.removeItem('session');
                return false;
            }
        }

        function clearSession() {
            localStorage.removeItem('session');
            sessionToken = null;
        }

        // Initialize
        function init() {
            if (validateSession()) {
                loadUserData();
                showMainApp();
            }
        }

        // Authentication
        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                alert('Please enter username and password');
                return;
            }

            const usernameError = validateUsername(username);
            if (usernameError) {
                alert(usernameError);
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[username];

            if (!user) {
                alert('Invalid credentials');
                return;
            }

            // Hash the entered password with the stored salt
            const hashedPassword = await hashPassword(password, user.salt);

            if (hashedPassword === user.passwordHash) {
                currentUser = { username };
                createSession(username);
                loadUserData();
                showMainApp();
            } else {
                alert('Invalid credentials');
            }
        }

        async function showSignup() {
            const username = prompt('Choose a username (3-20 characters, letters/numbers/underscore only):');
            if (!username) return;

            const trimmedUsername = username.trim();
            const usernameError = validateUsername(trimmedUsername);
            if (usernameError) {
                alert(usernameError);
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (users[trimmedUsername]) {
                alert('Username already exists');
                return;
            }
            
            const password = prompt('Choose a password (min 8 chars, must include uppercase, lowercase, and number):');
            if (!password) return;

            const passwordError = validatePassword(password);
            if (passwordError) {
                alert(passwordError);
                return;
            }

            const confirmPassword = prompt('Confirm your password:');
            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            // Security question for password recovery
            const securityQuestions = [
                "What was the name of your first pet?",
                "What city were you born in?",
                "What is your favorite plant?",
                "What was your childhood nickname?",
                "What is your mother's maiden name?"
            ];

            let questionChoice = prompt(
                'Choose a security question for password recovery:\n\n' +
                securityQuestions.map((q, i) => `${i + 1}. ${q}`).join('\n') +
                '\n\nEnter the number (1-5):'
            );

            if (!questionChoice) return;
            
            const questionIndex = parseInt(questionChoice) - 1;
            if (questionIndex < 0 || questionIndex >= securityQuestions.length) {
                alert('Invalid selection. Account creation cancelled.');
                return;
            }

            const securityAnswer = prompt(securityQuestions[questionIndex]);
            if (!securityAnswer || securityAnswer.trim().length < 2) {
                alert('Security answer is required. Account creation cancelled.');
                return;
            }

            // Generate salt and hash password
            const salt = generateSalt();
            const passwordHash = await hashPassword(password, salt);
            
            // Hash security answer as well
            const answerSalt = generateSalt();
            const answerHash = await hashPassword(securityAnswer.toLowerCase().trim(), answerSalt);

            users[trimmedUsername] = {
                passwordHash: passwordHash,
                salt: salt,
                securityQuestion: securityQuestions[questionIndex],
                securityAnswerHash: answerHash,
                securityAnswerSalt: answerSalt,
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('users', JSON.stringify(users));
            alert('Account created successfully! Please log in.');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                clearSession();
                currentUser = null;
                plants = [];
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
            }
        }

        // Forgot Password Flow
        let forgotPasswordUsername = null;

        function showForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.remove('hidden');
            document.getElementById('forgotPasswordStep1').classList.remove('hidden');
            document.getElementById('forgotPasswordStep2').classList.add('hidden');
            document.getElementById('forgotPasswordStep3').classList.add('hidden');
            document.getElementById('forgotUsername').value = '';
            forgotPasswordUsername = null;
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.add('hidden');
            forgotPasswordUsername = null;
        }

        function verifyUsername() {
            const username = document.getElementById('forgotUsername').value.trim();
            
            if (!username) {
                alert('Please enter your username');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[username];

            if (!user) {
                alert('Username not found');
                return;
            }

            if (!user.securityQuestion || !user.securityAnswerHash) {
                alert('This account was created before security questions were added. Please contact support or create a new account.');
                return;
            }

            // Show security question
            forgotPasswordUsername = username;
            document.getElementById('securityQuestionLabel').textContent = user.securityQuestion;
            document.getElementById('securityAnswer').value = '';
            document.getElementById('forgotPasswordStep1').classList.add('hidden');
            document.getElementById('forgotPasswordStep2').classList.remove('hidden');
        }

        function backToStep1() {
            document.getElementById('forgotPasswordStep2').classList.add('hidden');
            document.getElementById('forgotPasswordStep1').classList.remove('hidden');
            forgotPasswordUsername = null;
        }

        async function verifySecurityAnswer() {
            const answer = document.getElementById('securityAnswer').value.trim();
            
            if (!answer) {
                alert('Please enter your answer');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const user = users[forgotPasswordUsername];

            // Hash the provided answer with the stored salt
            const answerHash = await hashPassword(answer.toLowerCase().trim(), user.securityAnswerSalt);

            if (answerHash === user.securityAnswerHash) {
                // Answer is correct - proceed to password reset
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                document.getElementById('forgotPasswordStep2').classList.add('hidden');
                document.getElementById('forgotPasswordStep3').classList.remove('hidden');
            } else {
                alert('Incorrect answer. Please try again.');
            }
        }

        async function resetPassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (!newPassword || !confirmPassword) {
                alert('Please fill in both password fields');
                return;
            }

            const passwordError = validatePassword(newPassword);
            if (passwordError) {
                alert(passwordError);
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            // Generate new salt and hash new password
            const newSalt = generateSalt();
            const newPasswordHash = await hashPassword(newPassword, newSalt);

            // Update user's password
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            users[forgotPasswordUsername].passwordHash = newPasswordHash;
            users[forgotPasswordUsername].salt = newSalt;
            users[forgotPasswordUsername].passwordResetAt = new Date().toISOString();

            localStorage.setItem('users', JSON.stringify(users));

            alert('Password reset successfully! You can now log in with your new password.');
            closeForgotPasswordModal();
            forgotPasswordUsername = null;
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('usernameDisplay').textContent = currentUser.username;
            document.getElementById('userAvatar').textContent = currentUser.username[0].toUpperCase();
            renderPlants();
        }

        // Data Management
        function loadUserData() {
            const key = `plants_${currentUser.username}`;
            plants = JSON.parse(localStorage.getItem(key) || '[]');
        }

        function saveUserData() {
            const key = `plants_${currentUser.username}`;
            localStorage.setItem(key, JSON.stringify(plants));
        }

        // Plant Management
        function showAddPlantModal() {
            editingPlantId = null;
            document.getElementById('plantModalTitle').textContent = 'Add New Plant';
            document.getElementById('plantForm').reset();
            document.getElementById('plantImagePreview').classList.add('hidden');
            document.getElementById('plantDate').valueAsDate = new Date();
            
            // Populate parent plant options
            const parentSelect = document.getElementById('parentPlant');
            parentSelect.innerHTML = '<option value="">None - New Seed/Purchase</option>';
            plants.forEach(plant => {
                parentSelect.innerHTML += `<option value="${plant.id}">${plant.name}</option>`;
            });
            
            document.getElementById('plantModal').classList.remove('hidden');
        }

        function closePlantModal() {
            document.getElementById('plantModal').classList.add('hidden');
        }

        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function savePlant(event) {
            event.preventDefault();
            
            const plant = {
                id: editingPlantId || Date.now().toString(),
                name: document.getElementById('plantName').value,
                species: document.getElementById('plantSpecies').value,
                datePlanted: document.getElementById('plantDate').value,
                parentPlant: document.getElementById('parentPlant').value,
                notes: document.getElementById('plantNotes').value,
                image: document.getElementById('plantImagePreview').src || null,
                status: 'alive',
                updates: [],
                createdAt: editingPlantId ? plants.find(p => p.id === editingPlantId).createdAt : new Date().toISOString()
            };

            if (editingPlantId) {
                const index = plants.findIndex(p => p.id === editingPlantId);
                plant.updates = plants[index].updates;
                plants[index] = plant;
            } else {
                plants.push(plant);
            }

            saveUserData();
            renderPlants();
            closePlantModal();
        }

        // Plant Details
        async function showPlantDetail(plantId) {
            currentPlantId = plantId;
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;

            document.getElementById('detailPlantName').textContent = plant.name;
            
            const parentPlant = plant.parentPlant ? plants.find(p => p.id === plant.parentPlant) : null;
            const parentInfo = parentPlant ? `<p><strong>Parent Plant:</strong> ${parentPlant.name}</p>` : '';

            // Show loading state while fetching POWO data
            document.getElementById('detailContent').innerHTML = `
                <div class="plant-detail">
                    <div>
                        <img src="${plant.image || 'https://via.placeholder.com/400x400?text=No+Image'}" 
                             class="plant-detail-image" alt="${plant.name}">
                    </div>
                    <div class="plant-detail-info">
                        <div class="plant-status ${plant.status === 'alive' ? 'status-alive' : 'status-archived'}">
                            ${plant.status === 'alive' ? 'ðŸŒ± Active' : 'ðŸ“¦ Archived'}
                        </div>
                        <h3>Details</h3>
                        <div class="plant-detail-section">
                            <p><strong>Species:</strong> ${plant.species || 'Not specified'}</p>
                            <p><strong>Date Planted:</strong> ${plant.datePlanted || 'Not specified'}</p>
                            ${parentInfo}
                            <p><strong>Initial Notes:</strong> ${plant.notes || 'None'}</p>
                        </div>
                        <div style="padding: 20px; text-align: center; color: var(--earth-medium);">
                            <p>Loading plant information from Kew Gardens database...</p>
                        </div>
                    </div>
                </div>
                <div class="updates-timeline">
                    <h3>Updates Timeline</h3>
                    ${plant.updates.length === 0 ? '<p style="color: var(--earth-medium);">No updates yet. Add your first update!</p>' : ''}
                    ${plant.updates.sort((a, b) => new Date(b.date) - new Date(a.date)).map(update => `
                        <div class="update-item">
                            <div class="update-header">
                                <span class="update-action">${update.action}</span>
                                <span class="update-date">${new Date(update.date).toLocaleDateString()}</span>
                            </div>
                            ${update.notes ? `<p>${update.notes}</p>` : ''}
                            ${update.image ? `<img src="${update.image}" class="update-image" alt="Update">` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('detailModal').classList.remove('hidden');

            // Get plant care information from POWO API
            const careInfo = await getPlantCareInfo(plant.species || plant.name);

            // Update the detail view with POWO data
            let detailHTML = `
                <div class="plant-detail">
                    <div>
                        <img src="${plant.image || 'https://via.placeholder.com/400x400?text=No+Image'}" 
                             class="plant-detail-image" alt="${plant.name}">
                    </div>
                    <div class="plant-detail-info">
                        <div class="plant-status ${plant.status === 'alive' ? 'status-alive' : 'status-archived'}">
                            ${plant.status === 'alive' ? 'ðŸŒ± Active' : 'ðŸ“¦ Archived'}
                        </div>
                        <h3>Details</h3>
                        <div class="plant-detail-section">
                            <p><strong>Species:</strong> ${plant.species || 'Not specified'}</p>
                            <p><strong>Date Planted:</strong> ${plant.datePlanted || 'Not specified'}</p>
                            ${parentInfo}
                            <p><strong>Initial Notes:</strong> ${plant.notes || 'None'}</p>
                        </div>
                        ${careInfo}
                    </div>
                </div>
                <div class="updates-timeline">
                    <h3>Updates Timeline</h3>
                    ${plant.updates.length === 0 ? '<p style="color: var(--earth-medium);">No updates yet. Add your first update!</p>' : ''}
                    ${plant.updates.sort((a, b) => new Date(b.date) - new Date(a.date)).map(update => `
                        <div class="update-item">
                            <div class="update-header">
                                <span class="update-action">${update.action}</span>
                                <span class="update-date">${new Date(update.date).toLocaleDateString()}</span>
                            </div>
                            ${update.notes ? `<p>${update.notes}</p>` : ''}
                            ${update.image ? `<img src="${update.image}" class="update-image" alt="Update">` : ''}
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('detailContent').innerHTML = detailHTML;
            document.getElementById('archiveBtn').textContent = plant.status === 'alive' ? 'Archive' : 'Unarchive';
        }

        // POWO API Integration
        async function searchPOWO(plantName) {
            try {
                const response = await fetch(`https://powo.science.kew.org/api/1/search?q=${encodeURIComponent(plantName)}&f=accepted_names&perPage=5`);
                if (!response.ok) throw new Error('POWO API request failed');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching from POWO:', error);
                return null;
            }
        }

        async function lookupPOWO(fqId) {
            try {
                const response = await fetch(`https://powo.science.kew.org/api/1/taxon/${fqId}`);
                if (!response.ok) throw new Error('POWO lookup failed');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error looking up POWO taxon:', error);
                return null;
            }
        }

        // Horticultural care database for common plants
        const careDatabase = {
            // Vegetables
            'raphanus': { // Radish
                seedlingTime: '3-7 days to germinate, 20-30 days to harvest',
                matureSize: '15-30 cm tall, roots 2-5 cm diameter',
                season: 'Spring and Fall (cool season crop)',
                watering: 'Water daily to keep soil consistently moist',
                sunlight: 'Full sun (6-8 hours)',
                soil: 'Well-draining, loose soil, pH 6.0-7.0'
            },
            'solanum lycopersicum': { // Tomato
                seedlingTime: '5-10 days to germinate, 60-85 days to harvest',
                matureSize: '60-180 cm tall depending on variety',
                season: 'Summer (warm season crop)',
                watering: 'Water deeply 2-3 times per week, more in hot weather',
                sunlight: 'Full sun (8+ hours)',
                soil: 'Rich, well-draining, pH 6.0-6.8'
            },
            'lactuca': { // Lettuce
                seedlingTime: '7-14 days to germinate, 30-70 days to harvest',
                matureSize: '15-30 cm tall',
                season: 'Spring and Fall (cool season crop)',
                watering: 'Keep soil consistently moist, water every 2-3 days',
                sunlight: 'Partial shade to full sun (4-6 hours)',
                soil: 'Rich, well-draining, pH 6.0-7.0'
            },
            
            // Herbs
            'ocimum': { // Basil
                seedlingTime: '5-10 days to germinate, 60-90 days to maturity',
                matureSize: '30-60 cm tall',
                season: 'Summer (warm season herb)',
                watering: 'Water when top inch of soil is dry, every 2-3 days',
                sunlight: 'Full sun (6-8 hours)',
                soil: 'Rich, well-draining, pH 6.0-7.0'
            },
            'mentha': { // Mint
                seedlingTime: '10-15 days to germinate, 90 days to maturity',
                matureSize: '30-90 cm tall, spreads vigorously',
                season: 'Spring to Fall',
                watering: 'Keep soil consistently moist, water every 2-3 days',
                sunlight: 'Partial shade to full sun',
                soil: 'Rich, moist, pH 6.0-7.0'
            },
            'petroselinum': { // Parsley
                seedlingTime: '14-28 days to germinate, 70-90 days to maturity',
                matureSize: '30-45 cm tall',
                season: 'Spring and Fall',
                watering: 'Water every 2-3 days, keep soil evenly moist',
                sunlight: 'Full sun to partial shade',
                soil: 'Rich, well-draining, pH 6.0-7.0'
            },
            
            // Flowers
            'rosa': { // Rose
                seedlingTime: 'Typically grown from cuttings, 1-2 years to first bloom',
                matureSize: '60-180 cm tall depending on variety',
                season: 'Spring to Fall blooming',
                watering: 'Water deeply twice weekly, more in hot weather',
                sunlight: 'Full sun (6+ hours)',
                soil: 'Rich, well-draining, pH 6.0-7.0'
            },
            'tagetes': { // Marigold
                seedlingTime: '5-7 days to germinate, 50-60 days to bloom',
                matureSize: '15-90 cm tall depending on variety',
                season: 'Summer (warm season annual)',
                watering: 'Water 2-3 times per week, drought tolerant once established',
                sunlight: 'Full sun (6-8 hours)',
                soil: 'Well-draining, pH 6.0-7.5'
            }
        };

        function getCareDataForPlant(scientificName) {
            if (!scientificName) return null;
            
            const nameLower = scientificName.toLowerCase();
            for (const [key, value] of Object.entries(careDatabase)) {
                if (nameLower.includes(key)) {
                    return value;
                }
            }
            return null;
        }

        async function getPlantCareInfo(plantName) {
            // Search POWO for the plant
            const searchResults = await searchPOWO(plantName);
            
            let powoInfo = '';
            let powoUrl = `https://powo.science.kew.org/search?q=${encodeURIComponent(plantName)}`;
            
            if (searchResults && searchResults.results && searchResults.results.length > 0) {
                const firstMatch = searchResults.results[0];
                powoUrl = `https://powo.science.kew.org${firstMatch.url}`;
                
                // Try to get detailed information
                const details = await lookupPOWO(firstMatch.fqId);
                
                if (details) {
                    const family = details.family || 'Unknown family';
                    const distribution = details.distribution ? 
                        (details.distribution.natives || []).slice(0, 5).map(d => d.name).join(', ') : 
                        'Distribution data not available';
                    
                    // Extract life form and biome if available
                    const lifeform = details.morphology?.lifeform || 'Not specified';
                    const climate = details.climate?.description || 'Not specified';
                    
                    // Get horticultural care data
                    const careData = getCareDataForPlant(firstMatch.name);
                    
                    let careInfoHTML = '';
                    if (careData) {
                        careInfoHTML = `
                            <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <h5 style="margin-bottom: 10px; font-size: 1em;">ðŸŒ± Growing Information</h5>
                                <ul style="font-size: 0.95em;">
                                    <li><strong>Seedling Time:</strong> ${careData.seedlingTime}</li>
                                    <li><strong>Mature Size:</strong> ${careData.matureSize}</li>
                                    <li><strong>Optimal Season:</strong> ${careData.season}</li>
                                    <li><strong>Watering:</strong> ${careData.watering}</li>
                                    <li><strong>Sunlight:</strong> ${careData.sunlight}</li>
                                    <li><strong>Soil:</strong> ${careData.soil}</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    powoInfo = `
                        <div class="care-info-box">
                            <h4>ðŸŒ¿ Plant Information from Kew Gardens</h4>
                            <ul>
                                <li><strong>Scientific Name:</strong> ${firstMatch.name || plantName}</li>
                                <li><strong>Author:</strong> ${firstMatch.author || 'Not specified'}</li>
                                <li><strong>Family:</strong> ${family}</li>
                                <li><strong>Life Form:</strong> ${lifeform}</li>
                                <li><strong>Native Range:</strong> ${distribution}</li>
                            </ul>
                            ${careInfoHTML}
                            ${!careData ? `
                                <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                                    ðŸ’¡ <strong>Care Tip:</strong> For detailed growing instructions, search for "${firstMatch.name}" care guides online or consult your local extension office.
                                </p>
                            ` : ''}
                            <p style="margin-top: 15px;">
                                <a href="${powoUrl}" target="_blank" style="color: white; text-decoration: underline; font-weight: 500;">
                                    View full botanical details on POWO â†’
                                </a>
                            </p>
                            <p style="margin-top: 10px; font-size: 0.85em; opacity: 0.85;">
                                Data from Plants of the World Online (Royal Botanic Gardens, Kew)
                            </p>
                        </div>
                    `;
                } else {
                    // Get care data even without full POWO details
                    const careData = getCareDataForPlant(firstMatch.name);
                    let careInfoHTML = '';
                    
                    if (careData) {
                        careInfoHTML = `
                            <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 8px; margin-top: 15px;">
                                <h5 style="margin-bottom: 10px; font-size: 1em;">ðŸŒ± Growing Information</h5>
                                <ul style="font-size: 0.95em;">
                                    <li><strong>Seedling Time:</strong> ${careData.seedlingTime}</li>
                                    <li><strong>Mature Size:</strong> ${careData.matureSize}</li>
                                    <li><strong>Optimal Season:</strong> ${careData.season}</li>
                                    <li><strong>Watering:</strong> ${careData.watering}</li>
                                    <li><strong>Sunlight:</strong> ${careData.sunlight}</li>
                                    <li><strong>Soil:</strong> ${careData.soil}</li>
                                </ul>
                            </div>
                        `;
                    }
                    
                    powoInfo = `
                        <div class="care-info-box">
                            <h4>ðŸŒ¿ Plant Found in POWO Database</h4>
                            <ul>
                                <li><strong>Scientific Name:</strong> ${firstMatch.name}</li>
                                <li><strong>Author:</strong> ${firstMatch.author || 'Not specified'}</li>
                                <li><strong>Family:</strong> ${firstMatch.family || 'Unknown'}</li>
                            </ul>
                            ${careInfoHTML}
                            ${!careData ? `
                                <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                                    ðŸ’¡ <strong>Care Tip:</strong> For growing instructions, search for "${firstMatch.name}" care guides online.
                                </p>
                            ` : ''}
                            <p style="margin-top: 15px;">
                                <a href="${powoUrl}" target="_blank" style="color: white; text-decoration: underline; font-weight: 500;">
                                    View full details on POWO â†’
                                </a>
                            </p>
                        </div>
                    `;
                }
            } else {
                // No POWO match - try local care database with common name
                const careData = getCareDataForPlant(plantName);
                
                if (careData) {
                    powoInfo = `
                        <div class="care-info-box">
                            <h4>ðŸŒ± Growing Information</h4>
                            <ul>
                                <li><strong>Seedling Time:</strong> ${careData.seedlingTime}</li>
                                <li><strong>Mature Size:</strong> ${careData.matureSize}</li>
                                <li><strong>Optimal Season:</strong> ${careData.season}</li>
                                <li><strong>Watering:</strong> ${careData.watering}</li>
                                <li><strong>Sunlight:</strong> ${careData.sunlight}</li>
                                <li><strong>Soil:</strong> ${careData.soil}</li>
                            </ul>
                            <p style="margin-top: 15px;">
                                <a href="https://powo.science.kew.org/search?q=${encodeURIComponent(plantName)}" target="_blank" style="color: white; text-decoration: underline;">
                                    Search POWO for botanical information â†’
                                </a>
                            </p>
                        </div>
                    `;
                } else {
                    // No data found anywhere - provide general resources
                    powoInfo = `
                        <div class="care-info-box">
                            <h4>ðŸ” Plant Information Resources</h4>
                            <p>No exact match found for "${plantName}". Try these trusted botanical resources:</p>
                            <ul>
                                <li><a href="https://powo.science.kew.org/search?q=${encodeURIComponent(plantName)}" target="_blank" style="color: white; text-decoration: underline;">Search Plants of the World Online (POWO)</a> - Royal Botanic Gardens, Kew</li>
                                <li><a href="https://www.rhs.org.uk/plants/search-results?query=${encodeURIComponent(plantName)}" target="_blank" style="color: white; text-decoration: underline;">Royal Horticultural Society</a></li>
                                <li><a href="https://garden.org/plants/search/text/?q=${encodeURIComponent(plantName)}" target="_blank" style="color: white; text-decoration: underline;">National Gardening Association</a></li>
                            </ul>
                            <p style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
                                ðŸ’¡ <strong>Tip:</strong> Try searching with the scientific name (genus + species) for more accurate results.
                            </p>
                        </div>
                    `;
                }
            }

            return powoInfo;
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
            currentPlantId = null;
        }

        // Updates
        function showAddUpdateModal() {
            document.getElementById('updateForm').reset();
            document.getElementById('updateImagePreview').classList.add('hidden');
            document.getElementById('updateModal').classList.remove('hidden');
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').classList.add('hidden');
        }

        function saveUpdate(event) {
            event.preventDefault();
            
            const update = {
                id: Date.now().toString(),
                action: document.getElementById('updateAction').value,
                notes: document.getElementById('updateNotes').value,
                image: document.getElementById('updateImagePreview').src || null,
                date: new Date().toISOString()
            };

            const plant = plants.find(p => p.id === currentPlantId);
            if (!plant) return;

            plant.updates.push(update);

            // Auto-archive if died
            if (update.action === 'died') {
                plant.status = 'archived';
            }

            saveUserData();
            closeUpdateModal();
            showPlantDetail(currentPlantId);
            renderPlants();
        }

        // Archive/Delete
        function archivePlant() {
            const plant = plants.find(p => p.id === currentPlantId);
            if (!plant) return;

            plant.status = plant.status === 'alive' ? 'archived' : 'alive';
            saveUserData();
            closeDetailModal();
            renderPlants();
        }

        function deletePlant() {
            if (!confirm('Are you sure you want to delete this plant? This cannot be undone.')) {
                return;
            }

            plants = plants.filter(p => p.id !== currentPlantId);
            saveUserData();
            closeDetailModal();
            renderPlants();
        }

        // Rendering
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'active') {
                document.getElementById('activePlantsView').classList.remove('hidden');
                document.getElementById('archivedPlantsView').classList.add('hidden');
            } else {
                document.getElementById('activePlantsView').classList.add('hidden');
                document.getElementById('archivedPlantsView').classList.remove('hidden');
            }
        }

        function renderPlants() {
            const activePlants = plants.filter(p => p.status === 'alive');
            const archivedPlants = plants.filter(p => p.status === 'archived');

            renderPlantList('activePlantsList', activePlants, 'No active plants yet. Start your garden journal by adding your first plant!');
            renderPlantList('archivedPlantsList', archivedPlants, 'No archived plants yet.');
        }

        function renderPlantList(containerId, plantList, emptyMessage) {
            const container = document.getElementById(containerId);
            
            if (plantList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>${emptyMessage}</h3>
                        ${containerId === 'activePlantsList' ? '<button class="btn btn-add" onclick="showAddPlantModal()">+ Add Your First Plant</button>' : ''}
                    </div>
                `;
                return;
            }

            container.innerHTML = plantList.map(plant => {
                const daysSincePlanted = plant.datePlanted ? 
                    Math.floor((new Date() - new Date(plant.datePlanted)) / (1000 * 60 * 60 * 24)) : 0;
                
                return `
                    <div class="plant-card" onclick="showPlantDetail('${plant.id}')">
                        <img src="${plant.image || 'https://via.placeholder.com/300x250?text=No+Image'}" 
                             class="plant-image" alt="${plant.name}">
                        <div class="plant-info">
                            <div class="plant-name">${plant.name}</div>
                            <div class="plant-meta">
                                ${plant.datePlanted ? `<span>ðŸŒ± Day ${daysSincePlanted}</span>` : ''}
                                <span>ðŸ“ ${plant.updates.length} updates</span>
                            </div>
                            ${plant.species ? `<p style="color: var(--earth-medium); margin: 8px 0;">${plant.species}</p>` : ''}
                            <div class="plant-status ${plant.status === 'alive' ? 'status-alive' : 'status-archived'}">
                                ${plant.status === 'alive' ? 'Active' : 'Archived'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize app
        init();
    </script>
</body>
</html>
